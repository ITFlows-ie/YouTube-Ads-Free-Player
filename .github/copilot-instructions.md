# GitHub Copilot Instructions for YouTube-Ads-Free

## Rules
- Никакого YouTube Data API.
- Не использовать fetch для получения рекомендаций.
- Не использовать локальные рекоммендации.

## Project Overview
- Single-page YouTube iframe player with a persistent queue, saved list, and imported playlists.
- Pure client-side app in vanilla JS; 
- State is stored in `localStorage`; there is no database or build step.

## Architecture & Key Modules
- UI shell: [index.html](index.html) with fixed IDs/classes; JS assumes these IDs exist (e.g. `ytUrl`, `queueList`, `queueOverlay`, playlist modals, etc.). When changing markup, update selectors in [js/main.js](js/main.js).
- Entry point / controller: [js/main.js](js/main.js)
  - Wires DOM events to queue, playlists, translations, recommendations, and autoplay.
  - Centralizes UI state such as autoplay toggle, playlist dropdown, modals, and input state.
- Queue & player:
  - [js/queue.js](js/queue.js) manages the play queue (`state.queue`, `state.currentIndex`), persistence (`state.storageKey` in `localStorage`), and queue UI rendering.
  - [js/player.js](js/player.js) wraps the YouTube IFrame API, stores per-video progress in `localStorage` (`ytProgress`), and exposes `playVideo` and `getSavedProgress`.
  - Do not embed iframes directly from new code; call `playVideo(videoId, container)` and let it manage the API and progress.
- Playlists & Saved:
  - [js/playlists.js](js/playlists.js) is the single source of truth for saved videos and imported playlists (stored under `ytPlaylistData` in `localStorage`).
  - `playlistStore.saved.videos` is the canonical Saved list; the queue for Saved is rebuilt from this on changes.
  - `playlistStore.queueView` holds the currently active logical playlist; main.js uses it to populate the queue via `activateAndLoad(pid)`.
- Recommendations:
  - [js/recommendations.js](js/recommendations.js) renders a simple in-app recommendations list from already-known video IDs.
  - The PHP endpoint [recs.php](recs.php) exposes a separate JSON API that scrapes YouTube `ytInitialData` and returns `{ items: [{ id, title, thumb }] }`; use this only from client JS via `fetch` (no server-side coupling).
- Utilities & i18n:
  - [js/utils.js](js/utils.js) contains URL/ID parsing (`extractId`, `extractPlaylistId`), embed URL construction (`buildEmbed`), HTML escaping, and metadata fetch via YouTube oEmbed (`fetchMeta`). New parsing helpers should live here.
  - [js/translations.js](js/translations.js) implements a simple dictionary-based i18n; keys are reused across languages. When adding UI text, add dictionary entries for all languages and then reference via `t('key')`.

## State & Persistence Conventions
- Queue state: stored as JSON under `ytQueueData` with `currentIndex` and minimal `{ id, original }` items; metadata is refetched on load via `fetchMeta`.
- Playlists state: stored as JSON under `ytPlaylistData` with `saved`, `playlists`, and `activePlaylistId`.
- Video progress: stored per video ID under `ytProgress` in seconds; `player.js` is responsible for read/write.
- Autoplay: boolean flag in `localStorage` under `ytAutoplayEnabled` (`'0'`/`'1'`). Changes should go through helper functions in [js/main.js](js/main.js).

## UI & Interaction Patterns
- Queue interactions:
  - Use `addToQueue`, `playIndex`, `next`, `prev`, `clearAllQueue`, and `reorderQueue` from [js/queue.js](js/queue.js); do not mutate `state.queue` directly from other modules.
  - Queue UI is regenerated by `updateQueueUI()`; when changing queue behavior, keep DOM structure (handles, delete buttons, drag-and-drop) consistent with existing markup.
- Saved list & undo behavior:
  - Deleting items while `playlistStore.queueView.activePlaylistId === 'saved'` propagates to the Saved playlist and shows a snackbar with undo (see `showUndoSnackbar` in [js/queue.js](js/queue.js)).
  - If you introduce new deletion flows affecting Saved, reuse the snackbar/undo pattern instead of silently removing items.
- Playlists workflow:
  - Importing a playlist uses `fetchPlaylistFeed` (in [js/playlist_fetch.js](js/playlist_fetch.js)) and `playlistStore.createImportedPlaylist` plus a confirmation modal.
  - Activating a playlist always rebuilds the queue from `playlistStore.queueView.items` (see `activateAndLoad` in [js/main.js](js/main.js)); new playlist features should follow this pattern instead of pushing directly into the queue.
- Modals and overlays (queue, playlist import/delete) are toggled via `hidden` attributes and focus is managed for basic accessibility; preserve this pattern when adding dialogs.

## Styling & Layout
- Core styles live in [css/base.css](css/base.css), [css/layout.css](css/layout.css), [css/components.css](css/components.css), and [css/responsive.css](css/responsive.css).
- When adding new UI pieces (e.g., a new panel or badge), follow existing BEM-like class naming (`queue-item`, `rec-item`, `rotate-hint`, etc.) and media query structure in [css/responsive.css](css/responsive.css).

## Local Development & Testing
- No build step: open [index.html](index.html) via a simple static server (or your local PHP host) to avoid `file://` CORS issues.
- To exercise the recommendations API, ensure PHP is enabled and call `/recs.php?v=<VIDEO_ID>`; expect a JSON response with an `items` array or an `error` code.

## When Modifying or Adding Features
- Prefer extending existing modules instead of creating new global scripts; e.g., new queue behavior goes into [js/queue.js](js/queue.js), new playlist behavior into [js/playlists.js](js/playlists.js).
- Keep business logic (state updates, persistence) in JS modules and treat HTML as a thin view layer.
- Maintain compatibility with current `localStorage` shapes; if you must change formats, add defensive parsing that tolerates older data.
